# SUSTECH-CS207-PROJECT：基于FPGA的矩阵计算器

# 一、项目概述

本项目旨在设计并实现一个基于FPGA的矩阵计算器电路。该电路需支持基于矩阵的生成、展示、矩阵运算等功能（矩阵维度默认上限为 $5\times 5$ )，通过开发板上的基础输入输出设备及UART串口实现与用户及系统的数据交互。

# 二、核心功能

系统开机后进入主菜单供用户选择具体功能：1．矩阵输入及存储，2．矩阵生成及存储，3．矩阵展示，4．矩阵运算。每种模式结束后可以选择继续停留在该模式下，也可以选择返回到主菜单。

“矩阵运算”功能下可以选择具体的运算类型，一种运算结束后可以选择继续当前运算类型，或者切换到其他运算类型，或者切换到主菜单。

系统采用开发板的拨码开关、按键开关以及Uart串口通信软件做输入，采用开发板的LED、7段数码显示管以及Uart串口通信软件按做输出。

说明：本系统中涉及到的矩阵，如未做特别说明，以维度为 $m\times n$ 的矩阵A为例，m和n为1~5之间的整数；矩阵元素的值为0~9之间的整数。

## 2.1 输入输出处理

### 2.1.1 输入

1．功能选择用开发板的拨码开关和按键：比如拨码开关上设置系统的工作模式，按键用作”确认键”。

2．用户在uart传输软件上输入矩阵相关信息，比如矩阵维度、矩阵元素，点击软件上的“发送”将数据送給系统。如下图红色方框所示。

说明：如uart功能未实现，使用键盘实现相同方式的输入则视为等价，不扣分。

<table border="1" ><tr>
<td>2 3 1 4 5 7 6 8</td>
<td>发送</td>
</tr></table>

### 2.1.2 输出


1．开发板的LED灯及数码管：对用户输入的矩阵、用户选择的运算数进行合法性检测，发现错误点亮一盏LED灯，如果没有错误则熄灭该LED灯，倒计时信息同步显示在7段数码显示管。

2.Uart传输软件的接收窗口：矩阵运算的运算数、运算结果，都通过uart输出到uart传输软件，在该软件上进行展示，如下图红色方框所示。

说明：如uart功能未实现，使用VGA实现相同格式的输出则视为等价，不扣分。

## 2.2 矩阵输入、生成及存储

说明：系统支持每种规格的矩阵最多存储x个（x可配置，默认为2）。系统支持的矩阵 $\text {A}\left(\mathrm {m}^{*}\mathrm {n}\right)$ m和n的值可配置，默认为1~5之间的整数。

### 2.2.1支持用户输入矩阵并存储矩阵

1．用户输入：用户在输入矩阵时应先输入矩阵的维度，再按先行后列的方式遍历输入每个矩阵元素的值。以维度为 $m\times n$ 的矩阵A为例，应先输入 $m$ ，再输入 $n,$  最后输入Aij(i从0到 $m-$ 1,i值确定时j的值从0到 $n-1$ )．例如，用户输入一个 $2^{*}3$  的矩阵，发送窗口种的数据以及对应矩阵如下表所示（无需在接收窗口显示该矩阵）。

<table border="1" ><tr>
<td>发送窗口的输入数据</td>
<td>生成的矩阵</td>
</tr><tr>
<td>2 3 4 5 6 7 8 9</td>
<td>4 5 6<br>7 8 9</td>
</tr></table>

<!-- 2 -->

## 2．系统检测：

（1）维度范围：如果用户输入的维度超出限制（1~5之间），则点亮检测报错LED灯，需要用户重新输入。

（2）矩阵元素的数值范围：如果用户输入的数组元素超出0~9的范围，则点亮检测报错LED灯，需要用户重新输入。

（3）矩阵元素的个数：如果用户输入的数组元素的数量不足，比如矩阵规模是2*3，但用户只输入了4个数据，则这4个数据被依次当作矩阵元素A00,A01,A02,A10，将A11,A12赋值为0；如果用户输入的数组元素的个数超出指定范围，比如矩阵规模是2*3，用户输入了8个矩阵元素，则只取前6个矩阵元素的值，第7、8个输入的矩阵元素不作数。

### 2.2.2 支持根据用户的指定生成矩阵并存储

用户在输入矩阵时应先输入矩阵的维度（以维度为mxn的矩阵A为例，先输入m再输入n）、矩阵的个数（不超过2个），再按先行后列的方式遍历生成每个矩阵元素的值。

例如，用户输入132（如下表左侧所示），表示需要产生2个1*3的矩阵A和B．电路因此生成6个随机数 826579，则A、B如下表右侧所示。

请注意：使用递增或递减的方式产生的数字不是随机数，不得分。

<table border="1" ><tr>
<td>用户输入</td>
<td>矩阵A</td>
<td>矩阵B</td>
</tr><tr>
<td>132</td>
<td>826</td>
<td>579</td>
</tr></table>

### 2.2.3 系统存储矩阵

系统可以存储用户输入的矩阵、系统根据用户指定生成的矩阵以及矩阵的编号（编号方式由设计者自行设计并在系统里实现，不由用户输入指定）。每种规格的矩阵最多存储x(x的值默认为2）个，如果同种类型的矩阵已存储了x个，再输入相同规格的矩阵，则新输入的矩阵覆盖原来的矩阵。应保证原存储的矩阵可能被新输入的相同规格的矩阵全部覆盖，比如原来有A,B，新输入C时覆盖了A，再新输入D时覆盖B。

<!-- 3 -->

### 2.3 矩阵展示

需以清晰方式展示矩阵，例如下图中，元素之间以空格、换行间隔，也可采用其他展示方式，需清晰并保证用户体验；一次展示多个矩阵时从上到下依次展示。

比如：输出一个2*3的矩阵A{{4,5,6},{7,8,9}},Uart通信助手的接收窗口显示如下所示。

<table border="1" ><tr>
<td>4 5 6</td>
</tr><tr>
<td>7 8 9</td>
</tr></table>

### 2.4 矩阵运算

系统支持的矩阵运算类型如下：矩阵转置、矩阵加法、标量和矩阵相乘、矩阵乘法、卷积，其中卷积运算为附加功能（bonus)，其他4类运算为必选。

在进行矩阵运算时用户先选择运算类型，系统在7段数码管显示选中的运算类型，系统将存储的矩阵信息显示在Uart软件的接收窗口，用户再选择运算数，系统将运算数显示在Uart软件的接收窗口，并进行计算，将运算结果显示在Uart软件的接收窗口。每个运算结束后用户可以通过开关返回到矩阵运算模式开始下一次的运算，或者返回到矩阵输入、生成及存储模式，存入新的运算数。

#### 2.4.1选择运算类型

用拨码开关来选择具体的运算类型（矩阵转置、矩阵加法、标量乘法、矩阵乘法、卷积（具体实现将在bonus部分说明，不做卷积bonus则无需支持该运算类型））。拨码开关设置好后按“确认键”（开发板上选择一个合适的按键）表示选择完毕。

用户选择完毕后，7段数码管上显示运算类型（矩阵转置 T、矩阵加法 A、标量乘法 B、矩阵乘法C、卷积J）

#### 2.4.2 显示存储矩阵的全部信息


Uart 通信软件的接收窗口中显示矩阵总数、矩阵规格列表 $\left(\mathrm {m}^{\star }\mathrm {n}^{\star }\mathrm {x},\right.$  其中m, $n$ 为矩阵A $\left(\mathrm {m}^{\star }\mathrm {n}\right)$ 的两个维度，x是这种规格矩阵的个数）。某规格的矩阵个数为0，则不显示该矩阵的规格列表。比如系统存储了3个矩阵，其中1个是 $2^{*}2$ 的矩阵，2个 $4^{*}5$ 的矩阵。则显示信息如下表所示（输出三组信息，每组信息之间以空格分隔）。

$2^{*}2^{*}1$ $4^{*}5^{*}2$

#### 2.4.3 选择运算数

#### 1．用户手动选择运算数

##### 1）用户从系统存储的矩阵中手动选择运算数

a.用户指定矩阵维度：用户依次输入运算数的维度m和n（每次输入一个维度后按“确认键”）

b.展示该维度下的所有矩阵：维度输入完毕后，系统在Uart通信助手的接收窗口中显示该维度的所有矩阵及其编号。（下表示范 a,b互动）

<table border="1" ><tr>
<td>用户输入</td>
<td>Uart 通信助手的接收窗口显示</td>
</tr><tr>
<td>23</td>
<td>1<br>123<br>456<br>2<br>111<br>789</td>
</tr></table>

c.用户选择矩阵输入对应编号，按“确认键”，表示选定该运算数。

d. Uart通信助手的接收窗口中显示该运算数（下表示范 $c,d$ 互动）。

<table border="1" ><tr>
<td>用户输入</td>
<td>Uart 通信助手的接收窗口显示</td>
</tr><tr>
<td>2</td>
<td>111<br>789</td>
</tr></table>

e.三种选择模式：系统根据运算类型来确定运算数的输入方式：

<!-- 5 -->

a）如果只需要一个矩阵作为运算数（比如 转置、卷积（矩阵作为卷积核）)，则用户只需要选择一次运算数；

b）如需要两个矩阵作为运算数（比如加、乘积）则上述a-d操作要进行2次；

c）如需要一个矩阵和一个常量（比如标量乘法）则先选择矩阵（a-d操作1次），再输入标量。标量值由开发板的拨码开关进行输入，按“确认键”表示标量输入完毕。

##### 2）系统判定运算数是否符合运算要求

矩阵加法、矩阵乘法运算对两个运算数都有要求（比如矩阵加法要求两个运算数的维度相同，A(Am*An）和B(Bm*Bn）矩阵乘法要求An与Bm相同等），如果运算数不符合要求，则应回到运算数的选择起始阶段重新选择运算数。根据运算数合法性的判定结果：

a.如运算数符合计算要求则进入计算模式。

b.如运算数不符合计算要求，则点亮报错LED，并开启输入倒计时（倒计时在数码管上同步显示）；

a）倒计时的时间以秒为单位，动态可配置（即系统运行过程中用户输入指定倒计时，不需要重新生成bit文件），倒计时的默认值为10秒，可配置时间为5~15秒。

b）倒计时内完成新的运算数指定（所有运算数的编号都完成输入并按“确认键”）则对新的运算数进行检查。

i.如果符合要求则进入计算模式

ii.如果不符合要求则按b进行操作。

c）倒计时到期没输入完则本次输入无效，需要再次回到运算数的选择起始阶段重新选择运算数。

#### 2．系统按照运算要求随机选择运算数

<!-- 6 -->

由系统自动从存储的矩阵中随机选择符合要求的运算数。涉及到标量乘法（ $x^{\star }A$ （矩阵维度 $\left.\left.\mathrm {m}^{*}\mathrm {n}\right)\right)$ 时，x取0~9之间的随机数。系统选择完毕后，将运算数依次显示到输出设备上，比如 $A^{*}B,$ ，先显示A 再显示B。

**2.4.4 矩阵计算**

**1．矩阵转置**：实现存储矩阵的转置运算

比如：对矩阵 $A(1*3)=\{1,2,3\}$ 进行转置，转置后的输出B在Uart通信软件的接收窗口显示应为：

<table border="1" ><tr>
<td>1<br>2<br>3</td>
</tr></table>

**2．矩阵加法**：实现两个同维度矩阵的加法运算。

比如对矩阵 $A(2^{*}3)=\{\{1,2,3\},\{3,4,5\}\}$ 和矩阵 $B(2*3)=\{\{3,3,3\},\{2,2,2\}\}$ 进行加法运算， $A+B=C,$ 运算结果 $C(2*3)=\{\{4,5,6\},\{5,6,7\}\},$ 在Uart通信软件的接收窗口显示应为：

<table border="1" ><tr>
<td>4 5 6</td>
</tr><tr>
<td>5 67</td>
</tr></table>

**3．矩阵标量乘法**：实现矩阵与一个标量的乘法运算

比如对矩阵A(2*3)={{1,2,3},{3,4,5}｝做标量乘法，乘数为3， $A^{*}3=C$ ，运算结果 $C(2*3)=\{{3,6,9},$ ｛9,12,15}}，在Uart通信软件的接收窗口显示应为：

<table border="1" ><tr>
<td>369</td>
</tr><tr>
<td>9 12 15</td>
</tr></table>

**4．矩阵乘法**：按照矩阵A维度为 $m\times n$ ，矩阵B维度为 $n\times p$ ，则结果矩阵C维度为 $m\times p$ ，其中元素 $C[i][j]=\sum (A[i][k]*B[k][j]),k从1$ 到 $n。$  （ $m,n,p$ 的范围都是1~5）

比如对矩阵 $A(2^{*}3)=\{\{1,2,3\},\{3,4,5\}\}$ 和矩阵 $B(3*2)=\{{1,0},{2,1},{3,2}\}进行矩阵乘法,$  $A^{*}B=C,$ 运算结果 $C(2*2)=\{\{14,8\},\{26,14\}\},$ ，在Uart通信软件的接收窗口显示应为：

<table border="1" ><tr>
<td>14 8<br>26 14</td>
</tr></table>


# 三、附加功能

## 3.1 输出矩阵时按列元素靠左对齐展示

## 3.2 设置功能

系统矩阵的相关参数动态可配置（即系统运行过程中用户输入指定参数，不需要重新生成bit文件即可生效）：

这些参数在矩阵输入、生成、检测和存储功能中都同步有效。

（1）每种规格的矩阵最大个数x,x的值默认为2，如果设置为5，表示每种规格的矩阵最多可生成5个。

（2）矩阵元素的数值范围：默认矩阵元素的数值范围是0~9，如果设置成-3,20，则表示可以生成［-3,20］之间的整数都是合法矩阵元素。

## 3.3 卷积功能

(暂不考虑)

## 3.4 UI设计

通过使用python、java等语言实现的UI设计用于提升用户体验。

电路部分需同时兼容串口调试助手测试。

